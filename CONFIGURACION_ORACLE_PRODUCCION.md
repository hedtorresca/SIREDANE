# Configuraci贸n de Oracle en Producci贸n - SIRE

Este documento describe c贸mo configurar y desplegar el sistema SIRE con Oracle como base de datos de destino en el ambiente de producci贸n.

##  Informaci贸n de Conexi贸n

### Base de Datos Oracle (DBKACTUS)
- **Host**: 10.168.48.79
- **Puerto**: 1522
- **Service Name**: dbkactus

### Esquemas Disponibles

#### RRAA_STAGING
- **Usuario**: RRAA_STAGING
- **Contrase帽a**: Dane2025
- **Tablespace Datos**: RRAA_STAGING_DAT
- **Tablespace ndices**: RRAA_STAGING_IDX
- **Prop贸sito**: Almacenamiento de datos de staging y control de IDs

#### RRAA_DWH
- **Usuario**: RRAA_DWH
- **Contrase帽a**: D4n3.rR3E*202S
- **Tablespace Datos**: RRAA_DWH_DAT
- **Tablespace ndices**: RRAA_DWH_IDX
- **Prop贸sito**: Data Warehouse para datos procesados

##  Instalaci贸n y Configuraci贸n

### 1. Prerrequisitos

- Docker y Docker Compose instalados
- Acceso de red a 10.168.48.79:1522
- Python 3.8+ (para scripts de prueba)
- Librer铆as Python: `cx_Oracle`, `requests`, `python-dotenv`

### 2. Instalaci贸n de Dependencias

```bash
pip install -r requirements.txt
```

### 3. Configuraci贸n de Variables de Entorno

El archivo `config/prod.oracle.env` ya est谩 configurado con los par谩metros de producci贸n:

```env
ENVIRONMENT=prod
DATABASE_TYPE=oracle
PROD_ORACLE_HOST=10.168.48.79
PROD_ORACLE_PORT=1522
PROD_ORACLE_SERVICE=dbkactus
PROD_ORACLE_JDBC_USER=RRAA_STAGING
PROD_ORACLE_JDBC_PASSWORD=Dane2025
```

### 4. Inicializaci贸n de la Base de Datos

Ejecuta el script de inicializaci贸n para crear las tablas necesarias:

```bash
python scripts_oracle/setup_oracle_prod.py
```

Este script:
- Verifica la conexi贸n a Oracle
- Crea las tablas necesarias en el esquema RRAA_STAGING
- Configura los 铆ndices y permisos

### 5. Despliegue con Docker

#### Opci贸n A: Script Autom谩tico (Recomendado)

```powershell
.\start-oracle-prod.ps1
```

#### Opci贸n B: Comandos Manuales

```bash
# Construir im谩genes
docker-compose -f docker-compose.oracle.prod.yml build

# Inicializar base de datos
docker-compose -f docker-compose.oracle.prod.yml run --rm sire-db-init

# Iniciar servicios
docker-compose -f docker-compose.oracle.prod.yml up -d
```

## И Pruebas

### Prueba de Conexi贸n

```bash
python scripts_oracle/test_oracle_prod.py
```

### Pruebas Manuales de la API

#### 1. Verificar Estado del Servicio
```bash
curl http://localhost:5003/
```

#### 2. Generar ID para Persona
```bash
curl -X POST "http://localhost:5003/generar-id-personas" \
  -H "Content-Type: application/json" \
  -d '{
    "tipo_documento": "CC",
    "numero_documento": "12345678",
    "primer_nombre": "Juan",
    "segundo_nombre": "Carlos",
    "primer_apellido": "P茅rez",
    "segundo_apellido": "Garc铆a",
    "fecha_nacimiento": "1990-01-15",
    "sexo_an": "M",
    "codigo_municipio_nacimiento": 11001,
    "codigo_pais_nacimiento": 170
  }'
```

#### 3. Generar ID para Empresa
```bash
curl -X POST "http://localhost:5003/generar-id-empresas" \
  -H "Content-Type: application/json" \
  -d '{
    "tipo_documento": "NIT",
    "numero_documento": "900123456",
    "razon_social": "Empresa de Prueba S.A.S.",
    "digito_verificacion": "7",
    "codigo_camara": "11001",
    "camara_comercio": "Bogot谩",
    "matricula": "12345",
    "fecha_matricula": "2020-01-15",
    "fecha_renovacion": "2021-01-15",
    "ultimo_ano_renovado": 2021,
    "fecha_vigencia": "2022-01-15",
    "fecha_cancelacion": null,
    "codigo_tipo_sociedad": "01",
    "tipo_sociedad": "Sociedad An贸nima",
    "codigo_organizacion_juridica": "01",
    "organizacion_juridica": "Sociedad An贸nima",
    "codigo_estado_matricula": "01",
    "estado_matricula": "Activa",
    "representante_legal": "Juan P茅rez",
    "num_identificacion_representante_legal": "12345678",
    "clase_identificacion_rl": "CC",
    "fecha_actualizacion": "2023-01-01T00:00:00"
  }'
```

##  Estructura de Base de Datos

### Tablas en RRAA_STAGING

#### control_ids_generados
Tabla de control para IDs estad铆sticos generados por la API.

```sql
CREATE TABLE control_ids_generados (
    id                        NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    id_estadistico            VARCHAR2(100) UNIQUE,
    tipo_entidad              VARCHAR2(2) CHECK (tipo_entidad IN ('01', '02')),
    tipo_documento            VARCHAR2(50),
    numero_documento          VARCHAR2(50),
    fecha_generacion          TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    estado                    VARCHAR2(20) DEFAULT 'generado',
    observaciones             CLOB,
    load_datetime             TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### raw_obt_empresas
Tabla para almacenar datos de empresas.

```sql
CREATE TABLE raw_obt_empresas (
    id_estadistico                    VARCHAR2(100),
    razon_social                      VARCHAR2(250),
    tipo_documento                    VARCHAR2(50),
    numero_documento                  VARCHAR2(50),
    -- ... otros campos
    load_date                         TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### raw_obt_personas
Tabla para almacenar datos de personas.

```sql
CREATE TABLE raw_obt_personas (
    id_estadistico                    VARCHAR2(100),
    tipo_documento                    VARCHAR2(50),
    numero_documento                  VARCHAR2(50),
    primer_nombre                     VARCHAR2(100),
    -- ... otros campos
    load_date                         TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

##  Configuraci贸n de Servicios

### FastAPI
- **Puerto**: 5003
- **Documentaci贸n**: http://localhost:5003/docs
- **ReDoc**: http://localhost:5003/redoc

### Airflow
- **Puerto**: 8080
- **Usuario**: admin
- **Contrase帽a**: admin

### PostgreSQL (Metadatos de Airflow)
- **Puerto**: 5432
- **Base de datos**: airflow
- **Usuario**: airflow
- **Contrase帽a**: airflow

##  Soluci贸n de Problemas

### Error de Conexi贸n a Oracle

1. **Verificar conectividad de red**:
   ```bash
   telnet 10.168.48.79 1522
   ```

2. **Verificar credenciales**:
   ```bash
   python scripts_oracle/setup_oracle_prod.py
   ```

3. **Verificar firewall y proxy**:
   - Aseg煤rate de que el puerto 1522 est茅 abierto
   - Verifica configuraciones de proxy si aplica

### Error en la API

1. **Verificar logs**:
   ```bash
   docker-compose -f docker-compose.oracle.prod.yml logs sire-fastapi
   ```

2. **Reiniciar servicio**:
   ```bash
   docker-compose -f docker-compose.oracle.prod.yml restart sire-fastapi
   ```

### Error en Airflow

1. **Verificar logs**:
   ```bash
   docker-compose -f docker-compose.oracle.prod.yml logs sire-airflow-webserver
   ```

2. **Inicializar base de datos de Airflow**:
   ```bash
   docker-compose -f docker-compose.oracle.prod.yml run --rm sire-airflow-webserver airflow db init
   ```

##  Monitoreo

### Verificar Estado de Servicios

```bash
# Estado de contenedores
docker-compose -f docker-compose.oracle.prod.yml ps

# Logs en tiempo real
docker-compose -f docker-compose.oracle.prod.yml logs -f

# Logs de un servicio espec铆fico
docker-compose -f docker-compose.oracle.prod.yml logs -f sire-fastapi
```

### M茅tricas de Base de Datos

```sql
-- Verificar conexiones activas
SELECT username, machine, program, status 
FROM v$session 
WHERE username IN ('RRAA_STAGING', 'RRAA_DWH');

-- Verificar espacio en tablespaces
SELECT tablespace_name, bytes/1024/1024 as MB 
FROM dba_data_files 
WHERE tablespace_name LIKE 'RRAA_%';
```

##  Consideraciones de Seguridad

1. **Credenciales**: Las contrase帽as est谩n en texto plano en los archivos de configuraci贸n. En producci贸n real, considera usar variables de entorno del sistema o un gestor de secretos.

2. **Red**: Aseg煤rate de que la comunicaci贸n con Oracle est茅 encriptada si es posible.

3. **Logs**: Los logs pueden contener informaci贸n sensible. Configura rotaci贸n y limpieza adecuada.

4. **Backup**: Implementa estrategias de backup para las tablas de control de IDs.

##  Soporte

Para problemas espec铆ficos:

1. Revisa los logs de los servicios
2. Ejecuta el script de pruebas: `python scripts_oracle/test_oracle_prod.py`
3. Verifica la conectividad de red a Oracle
4. Consulta la documentaci贸n de la API en http://localhost:5003/docs

---

**Nota**: Este sistema est谩 configurado para el ambiente de producci贸n de DANE. Aseg煤rate de tener los permisos necesarios antes de realizar cambios en la base de datos.
