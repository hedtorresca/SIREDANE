# Guía de Despliegue SIRE con Oracle en Producción

## Resumen de Cambios para Oracle

Se ha adaptado completamente el sistema SIRE para funcionar con Oracle como base de datos de destino, manteniendo PostgreSQL solo para Airflow.

## Archivos Creados/Modificados para Oracle

### 1. Scripts SQL para Oracle
- `scripts_sql/oracle/control_ids_generados.sql` - Tabla de control de IDs
- `scripts_sql/oracle/sire_obt_tables.sql` - Tablas OBT para Oracle
- `scripts_sql/oracle/cleanup_duplicates.sql` - Limpieza de duplicados
- `scripts_sql/oracle/migrate_to_control_table.sql` - Migración a tabla de control

### 2. FastAPI para Oracle
- `FastAPI/utils/utils_oracle.py` - Utilidades específicas para Oracle
- `FastAPI/Main_oracle.py` - API principal para Oracle

### 3. DAG para Oracle
- `airflow_dags/dag_sire_etl_oracle.py` - DAG adaptado para Oracle

### 4. Configuración de Producción
- `config/prod.oracle.env` - Variables de entorno para producción
- `docker-compose.oracle.prod.yml` - Docker Compose para producción
- `Dockerfile.fastapi.oracle` - Dockerfile específico para Oracle

### 5. Configuración de Base de Datos
- `src/config/db_config.py` - Actualizado con métodos para Oracle

## Diferencias Clave entre PostgreSQL y Oracle

### 1. Tipos de Datos
| PostgreSQL | Oracle |
|------------|--------|
| `BIGSERIAL` | `NUMBER GENERATED BY DEFAULT AS IDENTITY` |
| `VARCHAR(255)` | `VARCHAR2(255)` |
| `TEXT` | `CLOB` |
| `TIMESTAMP` | `TIMESTAMP` |

### 2. Sintaxis SQL
| PostgreSQL | Oracle |
|------------|--------|
| `SUBSTRING(id, 3)` | `SUBSTR(id, 3)` |
| `CAST(SUBSTRING(id, 3) AS INTEGER)` | `TO_NUMBER(SUBSTR(id, 3), 'XXXXXXXX')` |
| `COALESCE(value, 0)` | `NVL(value, 0)` |
| `IF EXISTS` | `IF NOT EXISTS` (diferente sintaxis) |

### 3. Conexiones
- **PostgreSQL**: `psycopg2` + `postgresql://`
- **Oracle**: `cx_Oracle` + `oracle://`

## Pasos para Despliegue en Producción

### Paso 1: Preparar Servidor Oracle
```bash
# Instalar Oracle Database (19c o superior)
# Crear usuario SIRE_PROD con permisos necesarios
# Configurar tnsnames.ora si es necesario
```

### Paso 2: Configurar Variables de Entorno
```bash
# Copiar y editar configuración de producción
cp config/prod.oracle.env .env

# Editar las siguientes variables:
# - PROD_ORACLE_JDBC_URL
# - PROD_ORACLE_JDBC_USER
# - PROD_ORACLE_JDBC_PASSWORD
# - PROD_ORACLE_CONNECTION_STRING
```

### Paso 3: Crear Esquemas y Tablas en Oracle
```sql
-- Conectar como SYSTEM o usuario con privilegios DBA
-- Ejecutar scripts en orden:

-- 1. Crear esquemas
@scripts_sql/oracle/create_schemas.sql

-- 2. Crear tablas de control
@scripts_sql/oracle/control_ids_generados.sql

-- 3. Crear tablas OBT
@scripts_sql/oracle/sire_obt_tables.sql

-- 4. Crear tablas Data Vault
@scripts_sql/oracle/sire_dv_tables.sql

-- 5. Crear tablas staging
@scripts_sql/oracle/sire_sta_tables.sql
```

### Paso 4: Desplegar con Docker
```bash
# Construir y ejecutar servicios
docker-compose -f docker-compose.oracle.prod.yml up -d

# Verificar que todos los servicios estén funcionando
docker-compose -f docker-compose.oracle.prod.yml ps
```

### Paso 5: Verificar Despliegue
```bash
# Verificar API
curl http://localhost:8001/

# Verificar Airflow
curl http://localhost:8080/health

# Verificar logs
docker-compose -f docker-compose.oracle.prod.yml logs sire-fastapi
```

## Configuración de Red y Seguridad

### 1. Firewall
```bash
# Abrir puertos necesarios
# 8001 - FastAPI SIRE
# 8080 - Airflow Web UI
# 5432 - PostgreSQL (solo interno)
```

### 2. SSL/TLS
```bash
# Configurar certificados SSL para producción
# Actualizar variables de entorno:
ENABLE_SSL=true
SSL_VERIFY=true
```

### 3. Autenticación
```bash
# Configurar usuarios y contraseñas seguras
# Usar secretos de Docker o Kubernetes
# Habilitar autenticación en Airflow
```

## Monitoreo y Logging

### 1. Logs de Aplicación
```bash
# Ver logs en tiempo real
docker-compose -f docker-compose.oracle.prod.yml logs -f sire-fastapi

# Ver logs de Airflow
docker-compose -f docker-compose.oracle.prod.yml logs -f sire-airflow-webserver
```

### 2. Métricas de Base de Datos
```sql
-- Verificar conexiones activas
SELECT username, machine, program FROM v$session WHERE username = 'SIRE_PROD';

-- Verificar espacio en tablas
SELECT table_name, num_rows, blocks, empty_blocks 
FROM user_tables 
WHERE table_name LIKE 'RAW_OBT_%' OR table_name = 'CONTROL_IDS_GENERADOS';
```

## Resolución de Problemas

### 1. Problemas de Conexión Oracle
```bash
# Verificar conectividad
telnet oracle-server 1521

# Verificar configuración TNS
tnsping PROD

# Verificar logs de Oracle
tail -f $ORACLE_BASE/diag/rdbms/*/trace/alert_*.log
```

### 2. Problemas de Performance
```sql
-- Verificar queries lentas
SELECT sql_text, elapsed_time, executions 
FROM v$sql 
WHERE elapsed_time > 1000000 
ORDER BY elapsed_time DESC;

-- Verificar índices
SELECT index_name, table_name, status 
FROM user_indexes 
WHERE table_name IN ('RAW_OBT_PERSONAS', 'RAW_OBT_EMPRESAS', 'CONTROL_IDS_GENERADOS');
```

### 3. Problemas de Memoria
```bash
# Verificar uso de memoria de contenedores
docker stats

# Verificar logs de OOM
dmesg | grep -i "killed process"
```

## Backup y Recuperación

### 1. Backup de Base de Datos
```bash
# Backup completo de Oracle
rman target /
BACKUP DATABASE PLUS ARCHIVELOG;

# Backup de esquemas específicos
expdp SIRE_PROD/password@PROD schemas=SIRE_DV,SIRE_STA directory=DATA_PUMP_DIR dumpfile=sire_backup.dmp
```

### 2. Backup de Configuración
```bash
# Backup de archivos de configuración
tar -czf sire_config_backup.tar.gz config/ docker-compose.oracle.prod.yml Dockerfile.fastapi.oracle

# Backup de DAGs
tar -czf sire_dags_backup.tar.gz airflow_dags/
```

## Escalabilidad

### 1. Horizontal Scaling
```yaml
# En docker-compose.oracle.prod.yml
services:
  sire-fastapi:
    deploy:
      replicas: 3
    # ... resto de configuración
```

### 2. Load Balancing
```nginx
# Configurar Nginx como load balancer
upstream sire_api {
    server sire-fastapi-1:8001;
    server sire-fastapi-2:8001;
    server sire-fastapi-3:8001;
}
```

## Migración desde PostgreSQL

Si ya tienes datos en PostgreSQL y quieres migrar a Oracle:

### 1. Exportar desde PostgreSQL
```sql
-- Exportar datos de control
COPY (SELECT * FROM sire_sta.control_ids_generados) TO '/tmp/control_ids.csv' WITH CSV HEADER;

-- Exportar datos OBT
COPY (SELECT * FROM sire_sta.raw_obt_personas) TO '/tmp/personas.csv' WITH CSV HEADER;
COPY (SELECT * FROM sire_sta.raw_obt_empresas) TO '/tmp/empresas.csv' WITH CSV HEADER;
```

### 2. Importar a Oracle
```sql
-- Usar SQL*Loader o herramientas de migración
-- Ejemplo con SQL*Loader:
sqlldr SIRE_PROD/password@PROD control=control_ids.ctl data=control_ids.csv
```

## Contacto y Soporte

Para problemas específicos de Oracle:
1. Revisar logs de la aplicación
2. Verificar conectividad de red
3. Consultar documentación de Oracle
4. Contactar al administrador de base de datos

## Checklist de Despliegue

- [ ] Servidor Oracle configurado y funcionando
- [ ] Usuario SIRE_PROD creado con permisos necesarios
- [ ] Esquemas y tablas creados en Oracle
- [ ] Variables de entorno configuradas
- [ ] Docker Compose ejecutándose correctamente
- [ ] API respondiendo en puerto 8001
- [ ] Airflow accesible en puerto 8080
- [ ] DAGs ejecutándose sin errores
- [ ] Datos insertándose correctamente en Oracle
- [ ] Logs configurados y monitoreados
- [ ] Backup configurado
- [ ] Seguridad implementada

